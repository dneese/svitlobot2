<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Світлобот • Прошивка</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: #333;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 250, 250, 0.2);
      width: 90%;
      max-width: 460px;
      text-align: center;
    }
    h1 {
      color: #fff;
      margin-bottom: 15px;
      font-size: 1.8em;
      position: relative;
    }
    h1::before {
      content: '';
      position: absolute;
      top: -15px; left: -15px; right: -15px; bottom: -15px;
      border: 2px solid #00fafa;
      border-radius: 12px;
      animation: glow 2s infinite;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px #00fafa; }
      50% { box-shadow: 0 0 25px #00fafa; }
    }
    .subtitle {
      color: #ccc;
      margin-bottom: 25px;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    label {
      display: block;
      color: #fff;
      font-weight: bold;
      margin-bottom: 6px;
    }
    select {
      width: 100%;
      padding: 10px;
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      font-size: 1em;
    }
    select:focus {
      outline: none;
      border-color: #00fafa;
      box-shadow: 0 0 8px rgba(0,250,250,0.5);
    }
    .install-section {
      margin-top: 25px;
      padding: 20px;
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
    }
    esp-web-install-button {
      --esp-tools-button-color: #28a745;
      --esp-tools-button-text-color: #fff;
      --esp-tools-button-border-radius: 4px;
      width: 100%;
    }
    .custom-install-btn {
      width: 100%;
      padding: 14px;
      font-size: 1.2em;
      font-weight: bold;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .custom-install-btn:hover {
      background: #218838;
    }
    .warning {
      background: #222;
      border-left: 4px solid #d29922;
      padding: 12px;
      margin-top: 25px;
      border-radius: 4px;
      font-size: 0.95em;
      color: #e3b505;
    }
    .instructions {
      margin-top: 30px;
      text-align: left;
      font-size: 0.95em;
      color: #ddd;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Світлобот</h1>
    <p class="subtitle">Веб-інсталятор прошивки</p>

    <div class="form-group">
      <label for="deviceSelect">Оберіть пристрій:</label>
      <select id="deviceSelect">
        <option value="">-- Оберіть --</option>
        <option value="wemos-d1-mini">Wemos D1 Mini (ESP8266)</option>
        <option value="esp32-wroom">ESP32 Wroom</option>
        <option value="esp32-c3-mini">ESP32-C3 Mini</option>
      </select>
    </div>

    <div class="form-group hidden" id="versionGroup">
      <label for="versionSelect">Оберіть версію прошивки:</label>
      <select id="versionSelect">
        <option value="">-- Оберіть --</option>
      </select>
    </div>

    <div class="install-section hidden" id="installSection">
      <p>Підключіть пристрій через USB та натисніть нижче</p>
      <esp-web-install-button id="installBtn">
        <button slot="activate" class="custom-install-btn">Прошити</button>
        <span slot="unsupported">Chrome/Edge</span>
        <span slot="not-allowed">HTTPS</span>
      </esp-web-install-button>
    </div>

    <div class="warning">
      <strong>Важливо:</strong> Програма надається «як є» (as is), без будь-яких гарантій. Автор не несе відповідальності за працездатність, втрату даних чи будь-які наслідки. Використовуєте виключно на власний ризик — претензій не приймаємо.
    </div>

    <div class="instructions">
      <h3>Інструкція:</h3>
      <ol>
        <li>Підключіть ESP до комп'ютера. Натисніть "Прошити" → оберіть порт.</li>
        <li>Після прошивки пристрій створить Wi-Fi <strong>svitlobot</strong> (пароль <strong>12345677</strong> або без).</li>
        <li>Підключіться до мережі.</li>
        <li>Відкриється налаштування (або вручну: <a href="http://192.168.4.1">http://192.168.4.1</a>).</li>
        <li>Введіть SSID, пароль Wi-Fi, ключ каналу → "Save".</li>
        <li>Пристрій перезавантажиться і підключиться до вашої мережі.</li>
      </ol>
      <p>Обговорення: <a href="https://t.me/svitlobot_api/1021">Telegram</a></p>
    </div>
  </div>

  <script>
    const deviceSelect = document.getElementById('deviceSelect');
    const versionSelect = document.getElementById('versionSelect');
    const versionGroup = document.getElementById('versionGroup');
    const installSection = document.getElementById('installSection');
    const installBtn = document.getElementById('installBtn');

    const devices = {
      'wemos-d1-mini': {chipFamily:'ESP8266',name:'Wemos D1 Mini',versions:[ 'v3.2.9','v2.9.0','v2.8.0.5','v2.8.0.4','v2.8.0.3-noLed','v2.8.0.3','v2.8.0.2','v2.8.0.1','v2.8.0','v2.7.9.1','v2.7.9','v2.7.8.1','v2.7.8-generic','v2.7.5','v2.7.3','v2.7','v2.6','v2.4']},
      'esp32-wroom': {chipFamily:'ESP32',name:'ESP32 Wroom',versions:['v3.7','v2.9.0','v2.8.0.5','v2.8.0.4']},
      'esp32-c3-mini': {chipFamily:'ESP32-C3',name:'ESP32-C3 Mini',versions:['v3.7','v2.9.0']}
    };

    const firmwarePaths = {
      'ESP8266': {
		'v3.2.9': 'firmware/esp8266/SVITLOBOT_v3.2.9_ESP8266.bin',
        'v2.9.0': 'firmware/esp8266/svitlobot_esp8266_2_9_0.bin',
        'v2.8.0.5': 'firmware/esp8266/svitlobot2_8_0_5_esp8266.bin',
        'v2.8.0.4': 'firmware/esp8266/svitlobot2_8_0_4.ino.bin',
        'v2.8.0.3-noLed': 'firmware/esp8266/svitlobot2_8_0_3.noLed.bin',
        'v2.8.0.3': 'firmware/esp8266/svitlobot2_8_0_3.esp8266.nodemcuv2.bin',
        'v2.8.0.2': 'firmware/esp8266/svitlobot2_8_0_2.esp8266.nodemcuv2.bin',
        'v2.8.0.1': 'firmware/esp8266/svitlobot2_8_0_1.ino.bin',
        'v2.8.0': 'firmware/esp8266/svitlobot2_8_0.esp8266.nodemcuv2.bin',
        'v2.7.9.1': 'firmware/esp8266/svitlobot2_7_9_esp8266.generic.bin',
        'v2.7.9': 'firmware/esp8266/svitlobot2_7_9_esp8266.nodemcuv2.bin',
        'v2.7.8.1': 'firmware/esp8266/svitlobot2.7.8.esp8266.nodemcuv2.bin',
        'v2.7.8-generic': 'firmware/esp8266/svitlobot2.7.8.esp8266.generic.bin',
        'v2.7.5': 'firmware/esp8266/svitlobot2.7.5.+healthchecks_nodemcu.bin',
        'v2.7.3': 'firmware/esp8266/svitlobot2.7.3.nodemcu.bin',
        'v2.7': 'firmware/esp8266/svitlobot2.7.nodemcu.bin',
        'v2.6': 'firmware/esp8266/svitlobot2.6.nodemcu.bin',
        'v2.4': 'firmware/esp8266/svitlobot2.4.ino.nodemcu.bin'
      },
      'ESP32': {
        'v3.7': 'firmware/esp32/svitlobot_esp32_v3.7.target.bin',
        'v2.9.0': 'firmware/esp32/svitlobot_esp32_2_9_0.bin',
        'v2.8.0.5': 'firmware/esp32/svitlobot2_esp32_2_8_0_5.bin',
        'v2.8.0.4': 'firmware/esp32/svitlobot2_esp32_2_8_0_4.ino.merged.bin'
      },
      'ESP32-C3': {
        'v3.7': 'firmware/esp32/svitlobot_esp32c3_v3.7_target.bin',
        'v2.9.0': 'firmware/esp32/svitlobot2_esp32c3_2_9_0.bin'
        
      }
    };

    deviceSelect.addEventListener('change', () => {
      const device = deviceSelect.value;
      versionSelect.innerHTML = '<option value="">Оберіть версію</option>';
      if (device) {
        versionGroup.classList.remove('hidden');
        devices[device].versions.forEach(v => {
          const option = document.createElement('option');
          option.value = v;
          option.textContent = `Версія ${v}`;
          versionSelect.appendChild(option);
        });
        installSection.classList.add('hidden');
      } else {
        versionGroup.classList.add('hidden');
        installSection.classList.add('hidden');
      }
    });

    versionSelect.addEventListener('change', () => {
      const device = deviceSelect.value;
      const version = versionSelect.value;
      if (device && version) {
        const deviceInfo = devices[device];
        const chipFamily = deviceInfo.chipFamily;
        const relativePath = firmwarePaths[chipFamily][version];

        const baseUrl = window.location.origin + window.location.pathname.replace(/\/$/, '');
        const fullFirmwareUrl = new URL(relativePath, baseUrl + '/').href;

        const manifest = {
          name: `Svitlobot ${version} для ${deviceInfo.name}`,
          version: version,
          new_install_prompt_erase: true,
          builds: [{ chipFamily, parts: [{ path: fullFirmwareUrl, offset: 0 }] }]
        };

        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        installBtn.manifest = URL.createObjectURL(blob);
        installSection.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
